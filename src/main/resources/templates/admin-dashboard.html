<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard | XYZ Gym</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}">
</head>

<body class="dark">

<!-- ================= SIDEBAR ================= -->
<aside class="sidebar" id="sidebar">
    <div class="logo">XYZ GYM</div>

    <a href="#stats" class="active"><i class="bi bi-speedometer2"></i> Dashboard</a>
    <a href="#members"><i class="bi bi-people"></i> Members</a>
    <a href="#payments"><i class="bi bi-credit-card"></i> Payments</a>
    <a href="#notifications"><i class="bi bi-bell"></i> Notifications</a>

    <!-- âœ… ADD PLAN -->
    <a href="#" onclick="openAddPlanModal()">
        <i class="bi bi-plus-circle"></i> Add Plan
    </a>

    <a th:href="@{/admin/logout}" class="logout">
        <i class="bi bi-box-arrow-right"></i> Logout
    </a>
</aside>

<!-- ================= MAIN ================= -->
<div class="main">

    <!-- ================= TOP BAR ================= -->
    <header class="topbar">
        <button class="menu-btn d-md-none" onclick="toggleSidebar()">â˜°</button>

        <h4>Admin Dashboard</h4>

        <div class="top-actions">
            <div class="notification-icon" onclick="toggleNotifPopup()">
                <i class="bi bi-bell-fill"></i>
                <span class="count" th:text="${#lists.size(notifications)}"></span>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ—</button>
        </div>
    </header>

    <!-- ================= NOTIFICATION POPUP ================= -->
    <div class="notif-popup" id="notifPopup">
        <h6>Notifications</h6>

        <div th:each="n : ${notifications}" class="notif-item">
            <span th:text="${n.message}"></span>
            <small th:text="${#temporals.format(n.createdAt,'dd MMM yyyy')}"></small>
        </div>
    </div>

    <!-- ================= STATS ================= -->
    <section id="stats" class="stats">
        <div class="stat-card">
            <h6>Total Members</h6>
            <h3 th:text="${#lists.size(members)}"></h3>
        </div>

        <div class="stat-card">
            <h6>Total Revenue</h6>
            <h3>â‚¹ <span th:text="${#aggregates.sum(payments.![amount])}"></span></h3>
        </div>

        <div class="stat-card">
            <h6>Active Plans</h6>
            <h3 th:text="${#lists.size(plans)}"></h3>
        </div>
    </section>

    <!-- ================= MEMBERS ================= -->
    <section id="members" class="card-section">
        <div class="card-header">
            <h5>Members</h5>
            <input type="text" id="memberSearch" placeholder="Search member">
        </div>

        <table class="table table-dark table-hover">
            <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Plan</th>
                <th>Expiry</th>
                <th>Action</th>
            </tr>
            </thead>

            <tbody id="memberTable">
            <tr th:each="m : ${members}">
                <td th:text="${m.name}"></td>
                <td th:text="${m.email}"></td>
                <td th:text="${m.plan != null ? m.plan.planName : 'NA'}"></td>
                <td th:text="${m.expiryDate}"></td>
                <td>
                    <button class="btn btn-sm btn-danger"
                            th:onclick="'deleteMember(' + ${m.id} + ')'">
                        Delete
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </section>

    <!-- ================= PAYMENTS ================= -->
    <section id="payments" class="card-section">
        <div class="card-header">
            <h5>Payments</h5>
            <button class="btn btn-sm btn-success" onclick="exportCSV()">Export CSV</button>
        </div>

        <table class="table table-dark table-striped">
            <thead>
            <tr>
                <th>Member</th>
                <th>Plan</th>
                <th>Amount</th>
                <th>Date</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="p : ${payments}">
                <td th:text="${p.member.name}"></td>
                <td th:text="${p.plan.planName}"></td>
                <td>â‚¹ <span th:text="${p.amount}"></span></td>
                <td th:text="${#dates.format(p.paymentDate,'dd-MM-yyyy')}"></td>
            </tr>
            </tbody>
        </table>
    </section>

    <!-- ================= NOTIFICATIONS SECTION ================= -->
    <section id="notifications" class="card-section">
        <h5>All Active Notifications</h5>

        <div class="notif-list">
            <div th:each="n : ${notifications}" class="notif-box">
                <b th:text="${n.message}"></b>
                <small th:text="${#temporals.format(n.createdAt,'dd MMM yyyy')}"></small>
            </div>
        </div>
    </section>
    <!-- à¤¬à¤¾à¤•à¥€ sections (Members / Payments / Notifications) SAME à¤†à¤¹à¥‡à¤¤ -->
</div>

<!-- ================= ADD PLAN MODAL ================= -->
<div class="modal fade" id="addPlanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title">Add New Plan</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input id="planName" class="form-control mb-3" placeholder="Plan Name">
                <input id="planDuration" type="number" class="form-control mb-3" placeholder="Duration (Months)">
                <input id="planPrice" type="number" class="form-control" placeholder="Price (â‚¹)">
            </div>

            <div class="modal-footer border-0">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success" onclick="savePlan()">Save Plan</button>
            </div>
        </div>
    </div>
</div>



<!-- ================= JS ================= -->
<script>
    function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("open");
    }

    function toggleTheme() {
        document.body.classList.toggle("light");
    }

    function toggleNotifPopup() {
        document.getElementById("notifPopup").classList.toggle("show");
    }

    // Member search
    document.getElementById("memberSearch").addEventListener("keyup", function () {
        let val = this.value.toLowerCase();
        document.querySelectorAll("#memberTable tr").forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none";
        });
    });

    // Export CSV
    function exportCSV() {
        let csv = "Member,Plan,Amount,Date\n";
        document.querySelectorAll("#payments tbody tr").forEach(row => {
            let cols = row.querySelectorAll("td");
            csv += `${cols[0].innerText},${cols[1].innerText},${cols[2].innerText},${cols[3].innerText}\n`;
        });

        let blob = new Blob([csv], { type: "text/csv" });
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "payments.csv";
        a.click();
    }

    function openAddPlanModal() {
        new bootstrap.Modal(document.getElementById("addPlanModal")).show();
    }

    function savePlan() {
        fetch("/admin/addPlan", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body:
                "planName=" + planName.value +
                "&durationMonths=" + planDuration.value +
                "&price=" + planPrice.value
        }).then(() => location.reload());
    }
</script>

</body>
</html>
