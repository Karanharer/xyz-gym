<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: #121212;
            color: #e0e0e0;
            font-family: 'Poppins', sans-serif;
        }

        .card {
            background: #1f1f1f;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1f1f1f;
            padding: 20px;
            border-radius: 12px;
            display: none;
            z-index: 2000;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-bell span {
            background: red;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background: #1f1f1f;
            padding: 10px;
            width: 250px;
        }

        .notification-bell:hover .notification-dropdown {
            display: block;
        }
    </style>
</head>
<body class="container-fluid p-4">

<!-- ================= HEADER ================= -->
<div class="d-flex justify-content-between mb-3">
    <h3>Admin Dashboard</h3>

    <div class="notification-bell">
        ðŸ”” <span th:text="${#lists.size(notifications)}"></span>
        <div class="notification-dropdown">
            <div th:each="n : ${notifications}">
                <div th:text="${n.message}"></div>
                <hr>
            </div>
        </div>
    </div>
</div>

<!-- ================= MEMBERS ================= -->
<div class="card p-3">
    <h4>Members</h4>

    <table class="table table-dark table-hover">
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Plan</th>
            <th>Action</th>
        </tr>

        <tr th:each="m : ${members}">
            <td th:text="${m.name}"></td>
            <td th:text="${m.email}"></td>
            <td th:text="${m.plan.planName}"></td>
            <td>
                <button class="btn btn-sm btn-warning"
                        th:onclick="'editMember(' + ${m.id} + ',\'' + ${m.name} + '\',\'' + ${m.email} + '\')'">Edit
                </button>
                <button class="btn btn-sm btn-danger"
                        th:onclick="'deleteMember(' + ${m.id} + ')'">Delete
                </button>
            </td>
        </tr>
    </table>
</div>

<!-- ================= PAYMENT HISTORY ================= -->
<div class="card p-3">
    <h4>Payment History</h4>

    <table class="table table-dark">
        <tr>
            <th>Member</th>
            <th>Plan</th>
            <th>Amount</th>
            <th>Date</th>
        </tr>

        <tr th:each="p : ${payments}">
            <td th:text="${p.member.name}"></td>
            <td th:text="${p.plan.planName}"></td>
            <td th:text="'â‚¹' + ${p.amount}"></td>
            <td th:text="${p.date}"></td>
        </tr>
    </table>
</div>

<!-- ================= REVENUE CHART ================= -->
<div class="card p-3">
    <h4>Plan Wise Revenue</h4>
    <canvas id="revenueChart"></canvas>
</div>

<!-- ================= MEMBER EDIT POPUP ================= -->
<div id="memberPopup" class="popup">
    <h5>Edit Member</h5>
    <input type="hidden" id="mid">
    <input id="mname" class="form-control mb-2" placeholder="Name">
    <input id="memail" class="form-control mb-2" placeholder="Email">
    <button class="btn btn-success" onclick="saveMember()">Save</button>
    <button class="btn btn-secondary" onclick="closePopup()">Close</button>
</div>

<!-- ================= JS ================= -->
<script>
    let labels = [], data = [];

    /* Thymeleaf generates JS arrays */
    /* [[${variable}]] syntax allows inline JS values */
    /* We will use th:inline="javascript" */
</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    labels = [[${#lists.map(revenue, r -> r.plan)}]];
    data = [[${#lists.map(revenue, r -> r.total)}]];

    new Chart(document.getElementById("revenueChart"), {
        type: 'bar',
        data: {labels: labels, datasets: [{data: data}]}
    });

    function editMember(id, n, e) {
        mid.value = id;
        mname.value = n;
        memail.value = e;
        memberPopup.style.display = "block";
    }

    function closePopup() {
        memberPopup.style.display = "none";
    }

    function saveMember() {
        fetch("/admin/editMember", {
            method: "POST",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: "id=" + mid.value + "&name=" + mname.value + "&email=" + memail.value
        }).then(() => location.reload());
    }

    function deleteMember(id) {
        if (confirm("Delete Member?")) {
            fetch("/admin/deleteMember", {
                method: "POST",
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: "id=" + id
            }).then(() => location.reload());
        }
    }
    /*]]>*/
</script>

</body>
</html>
